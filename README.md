# Used Stuff Market

## Prerequisites
- [uv](https://docs.astral.sh/uv/)
- [Python 3.13](https://www.python.org/downloads/release/python-3137/)
- [docker](https://docs.docker.com/engine/install/) (compatible solution such as [colima](https://github.com/abiosoft/colima) or [podman](https://podman.io/docs/installation) also works)

## Installation

```bash
uv sync
```

## Running project

```bash
# Start dependencies
docker compose up

# Run migrations for the first time
make migrate

# Start server
make run
# OR start server with reload on code change
make run-reload
```

## Running tests

Use with dependencies from docker-compose.yml running.

```bash
make test
```

## Formatting

```bash
make fmt
```

## Linting

```bash
make lint
```

## Migrations

### Upgrading to the latest version

```bash
make migrate
```

NOTE: Tests also use migrations, so one needs to generate one during development.

### Generating a new migration with auto-changes detection

```bash
uv run alembic -c used_stuff_market/db/alembic.ini revision --autogenerate -m "MESSAGE"
```

âš  NOTE: New schemas NEED to be added manually to the migration, e.g.
```diff
--- used_stuff_market/db/migrations/versions/562894b9762e_add_payments.py_original  2022-10-17 20:43:21.000000000 +0200
+++ used_stuff_market/db/migrations/versions/562894b9762e_add_payments.py   2022-10-17 20:01:02.000000000 +0200
@@ -18,6 +18,7 @@

 def upgrade() -> None:
     # ### commands auto generated by Alembic - please adjust! ###
+    op.execute("CREATE SCHEMA payments")
     op.create_table(
         "payments",
         sa.Column("uuid", postgresql.UUID(as_uuid=True), nullable=False),
```

