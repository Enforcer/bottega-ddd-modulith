# Used Stuff Market

## Start up
```bash
python -m venv ve310
source ve310/bin/activate
pip install poetry
poetry install

docker compose up

alembic -c used_stuff_market/db/alembic.ini upgrade head
```

## Makefile commands

`make fmt` - run isort & black

`make test` - run pytest

`make run` - start FastAPI server

`run-reload` - start FastAPI server with hot code reloading on changes

## Migrations

### Upgrading to the latest version
```bash
alembic -c used_stuff_market/db/alembic.ini upgrade head
```

NOTE: Tests do not use migrations, they create a schema from models

### Generating new migration with auto-changes detection

```bash
alembic -c used_stuff_market/db/alembic.ini revision --autogenerate -m "MESSAGE"
```

âš  NOTE: New schemas NEED to be added manually to the migration AND tests, e.g.
```diff
--- used_stuff_market/db/migrations/versions/562894b9762e_add_payments.py_original	2022-10-17 20:43:21.000000000 +0200
+++ used_stuff_market/db/migrations/versions/562894b9762e_add_payments.py	2022-10-17 20:01:02.000000000 +0200
@@ -18,6 +18,7 @@

 def upgrade() -> None:
     # ### commands auto generated by Alembic - please adjust! ###
+    op.execute("CREATE SCHEMA payments")
     op.create_table(
         "payments",
         sa.Column("uuid", postgresql.UUID(as_uuid=True), nullable=False),
```

```diff
--- tests/conftest.py_before	2022-10-17 20:43:34.000000000 +0200
+++ tests/conftest.py	2022-10-17 19:37:05.000000000 +0200
@@ -26,6 +26,7 @@
         connection.execute(text(f"CREATE SCHEMA availability"))
         connection.execute(text(f"CREATE SCHEMA catalog"))
         connection.execute(text(f"CREATE SCHEMA items"))
+        connection.execute(text(f"CREATE SCHEMA payments"))

     Base.metadata.create_all(bind=test_db_engine)
     yield
```


